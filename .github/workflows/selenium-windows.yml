name: Selenium tests (Windows) - mirror Jenkins pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selenium-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      VENV_DIR: venv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11 (Windows)
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Prepare Python virtualenv & install dependencies (Windows)
        shell: pwsh
        run: |
          python -m venv $env:VENV_DIR
          $venvPip = Join-Path $env:VENV_DIR "Scripts\pip.exe"
          Write-Host "Upgrading pip..."
          & $venvPip install --upgrade pip
          Write-Host "Install pinned selenium + webdriver-manager + project requirements..."
          & $venvPip install selenium==4.38.0 webdriver-manager pytest pytest-html allure-pytest pytest-xdist pytest-rerunfailures
          if (Test-Path ./selenium-tests/requirements.txt) {
            & $venvPip install -r ./selenium-tests/requirements.txt
          }

      - name: Show environment info (debug)
        shell: pwsh
        run: |
          Write-Host "Python:"; python --version
          Write-Host "Selenium version:"; python -c "import selenium; print(selenium.__version__)"
          Write-Host "Chrome version:"; (& 'C:\Program Files\Google\Chrome\Application\chrome.exe' --version) -join "`n" || Write-Host "chrome not found"
          Write-Host "Chromedriver (if present):"; (& chromedriver --version) -join "`n" || Write-Host "chromedriver not in PATH"

      - name: Prepare reports (clean/create allure-results)
        shell: pwsh
        working-directory: .
        run: |
          $reportDir = "selenium-tests\reports\allure-results"
          Remove-Item -Recurse -Force $reportDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $reportDir

      - name: Run Selenium tests (Windows) - pytest
        shell: pwsh
        working-directory: ./selenium-tests
        env:
          PYTHONPATH: .
        run: |
          $venvPy = Join-Path $env:VENV_DIR "Scripts\python.exe"
          Write-Host "Running pytest..."
          # Run pytest against your tests folder (similar to Jenkins). Add flags if you want report outputs.
          & $venvPy -m pytest . -q --junitxml=reports/junit-windows.xml --alluredir=reports/allure-results || $LASTEXITCODE = $LASTEXITCODE; exit $LASTEXITCODE

      - name: List reports for troubleshooting
        shell: pwsh
        run: |
          Write-Host "Reports folder contents:"
          Get-ChildItem -Recurse -Path selenium-tests\reports | Select-Object FullName,Length | Format-Table -AutoSize

      - name: Upload Selenium reports artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-reports-windows
          path: selenium-tests/reports/
