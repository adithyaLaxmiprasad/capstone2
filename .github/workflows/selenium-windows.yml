name: Selenium tests (Windows) - 2 Selected Tests Only

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selenium-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      VENV_DIR: venv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11 (Windows)
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Prepare Python virtualenv & install dependencies (Windows)
        shell: pwsh
        run: |
          python -m venv $env:VENV_DIR
          $venvPip = Join-Path $env:VENV_DIR "Scripts\pip.exe"

          Write-Host "Upgrading pip..."
          & $venvPip install --upgrade pip

          Write-Host "Install Selenium + WebDriver Manager + Framework requirements..."
          & $venvPip install selenium==4.38.0 webdriver-manager pytest pytest-html allure-pytest pytest-xdist pytest-rerunfailures

          if (Test-Path ./selenium-tests/requirements.txt) {
            & $venvPip install -r ./selenium-tests/requirements.txt
          }

      - name: Show environment info (debug)
        shell: pwsh
        run: |
          Write-Host "Python:"; python --version
          Write-Host "Selenium version:"; python -c "import selenium; print(selenium.__version__)"
          Write-Host "Chrome version:"
          try {
            & 'C:\Program Files\Google\Chrome\Application\chrome.exe' --version
          } catch {
            Write-Host "Chrome not found in default path."
          }

      - name: Prepare reports folder
        shell: pwsh
        run: |
          $reportDir = "selenium-tests\reports\allure-results"
          Remove-Item -Recurse -Force $reportDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $reportDir | Out-Null

      - name: Run ONLY 2 Selenium tests
        shell: pwsh
        working-directory: ./selenium-tests
        env:
          PYTHONPATH: .
        run: |
          $venvPy = Join-Path $env:VENV_DIR "Scripts\python.exe"
          Write-Host "Running ONLY selected tests..."

          & $venvPy -m pytest `
            tests/test_register_and_login.py::test_register_and_login `
            tests/test_search_and_add_to_cart.py::test_search_and_add_to_cart `
            -q `
            --junitxml=reports/junit-windows.xml `
            --alluredir=reports/allure-results

      - name: List report files
        if: always()
        shell: pwsh
        run: |
          Write-Host "Reports folder contents:"
          Get-ChildItem -Recurse selenium-tests\reports | Format-Table -AutoSize

      - name: Upload Selenium Reports Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-reports-windows
          path: selenium-tests/reports/
          if-no-files-found: ignore
